    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>RAG Chatbot</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <style>
            /* Suggested Questions Styles */
            .suggested-questions-area {
                padding: 10px 0;
                margin-bottom: 0;
                overflow-x: auto;
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE and Edge */
                position: absolute;
                bottom: 70px; /* V·ªã tr√≠ c·ªë ƒë·ªãnh ph√≠a tr√™n khu v·ª±c input */
                left: 0;
                right: 0;
                cursor: grab; /* Indicates the area is draggable */
                background-color: #1e1e2e;
                z-index: 10;
                border-top: 1px solid #333;
                border-bottom: 1px solid #333;
            }

            /* Hide scrollbar completely for all browsers */
            .suggested-questions-area::-webkit-scrollbar {
                display: none;
            }

            .suggested-questions-container {
                display: flex;
                flex-wrap: nowrap;
                gap: 8px;
                padding: 0 30px; /* Increased padding to account for shadows */
                width: max-content;
            }

            .suggested-question {
                background-color: #4a5568;
                color: white;
                padding: 8px 12px;
                border-radius: 16px;
                font-size: 0.85em;
                cursor: pointer;
                transition: background-color 0.3s, transform 0.1s;
                display: inline-block;
                white-space: nowrap;
                flex-shrink: 0;
                user-select: none; /* Prevent text selection during drag */
            }

            /* Style when dragging */
            .suggested-questions-area.dragging .suggested-question {
                transform: scale(0.98);
            }

            /* Scroll shadows to indicate more content */
            .scroll-shadow {
                position: absolute;
                top: 0;
                height: 100%;
                width: 30px;
                pointer-events: none;
                z-index: 1;
            }

            .scroll-shadow-left {
                left: 0;
                background: linear-gradient(to right, rgba(30, 30, 46, 0.8), rgba(30, 30, 46, 0));
                opacity: 0;
                transition: opacity 0.3s;
            }

            .scroll-shadow-right {
                right: 0;
                background: linear-gradient(to left, rgba(30, 30, 46, 0.8), rgba(30, 30, 46, 0));
                opacity: 1;
                transition: opacity 0.3s;
            }

            /* Responsive styles for suggested questions */
            @media (max-width: 768px) {
                .suggested-questions-area {
                    padding: 8px 0;
                    margin-bottom: 8px;
                }

                .suggested-question {
                    padding: 6px 10px;
                    font-size: 0.8em;
                }

                .scroll-shadow {
                    width: 20px;
                }
            }

            .suggested-question:hover {
                background-color: #2d3748;
            }

            /* Menu display styles */
            .menu-header {
                margin-bottom: 10px;
            }

            .menu-header h3 {
                font-size: 1.2em;
                color: #4299e1;
                margin: 0;
                padding: 0;
            }

            .menu-categories {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .menu-category-item {
                background-color: #2d3748;
                border-radius: 8px;
                padding: 10px;
                cursor: pointer;
                transition: background-color 0.3s;
            }

            .menu-category-item:hover {
                background-color: #4a5568;
            }

            .category-name {
                font-weight: bold;
                font-size: 1.1em;
                margin-bottom: 5px;
            }

            .category-description {
                font-size: 0.9em;
                color: #cbd5e0;
                margin-bottom: 5px;
            }

            .category-count {
                font-size: 0.8em;
                color: #a0aec0;
            }

            .menu-products {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .menu-product-item {
                background-color: #2d3748;
                border-radius: 8px;
                padding: 12px;
            }

            .product-name {
                font-weight: bold;
                font-size: 1.1em;
                margin-bottom: 3px;
            }

            .product-description {
                font-size: 0.9em;
                color: #e2e8f0;
                margin-bottom: 8px;
                line-height: 1.4;
            }

            .product-details {
                display: flex;
                justify-content: flex-end;
                font-size: 0.9em;
            }

            .product-category {
                color: #a0aec0;
                font-style: italic;
            }

            /* Simple menu styles */
            .menu-item {
                margin: 0;
                padding: 0;
                border: none;
                background: none;
                font-size: 1em;
                line-height: 1.4;
                cursor: pointer;
                color: #000000;
                display: block;
            }

            .menu-item:hover {
                text-decoration: underline;
            }

            .menu-title {
                font-weight: bold;
                margin: 0;
                padding: 0;
                display: block;
                font-size: 1.1em;
                border: none;
                color: #000000;
                line-height: 1.4;
            }

            .menu-subtitle {
                margin: 0;
                padding: 0;
                display: block;
                font-weight: normal;
                color: #000000;
                line-height: 1.4;
            }

            .menu-product {
                margin: 0;
                padding: 0;
                line-height: 1.4;
                white-space: normal;
                word-wrap: break-word;
                display: block;
                width: 100%;
                border: none;
            }

            .product-name {
                font-weight: normal;
                margin: 0;
                padding: 0;
                display: inline;
                color: #000000;
            }

            .product-description {
                display: block;
                margin: 0 0 0 10px;
                padding: 0;
                color: #000000;
            }
        </style>
    </head>
    <body>
        <div class="main-container">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <!-- Sidebar Toggle Button -->
                <button id="sidebar-toggle">‚ò∞</button> <br>

                <!-- Ph·∫ßn th√¥ng tin ng∆∞·ªùi d√πng -->
                <div class="sidebar-user-section">
                    {% if user_info %}
                        <h3><span style="font-size: 0.95em;">üë§</span> Th√¥ng tin ng∆∞·ªùi d√πng</h3>
                        <div style="background-color: #1e1e2e; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="font-size: 1.33em; color: #facc15; margin: 0 0 0.5rem 0;">{{ user_info.name }}</p>
                            <p style="font-size: 1em; color: #cbd5e1; margin: 0;">Kh√°ch h√†ng th√¢n thi·∫øt</p>
                            {% if purchase_history %}
                                <p style="font-size: 0.95em; color: #cbd5e1; margin: 0.5rem 0 0 0;">S·ªë ƒë∆°n h√†ng: <strong>{{ purchase_history|length }}</strong></p>
                            {% endif %}
                        </div>

                        <h3><span style="font-size: 0.95em;">üõçÔ∏è</span> L·ªãch s·ª≠ mua h√†ng</h3>
                        <div class="purchase-history">
                            {% if purchase_history %}
                                {% for item in purchase_history %}
                                    <div class="purchase-history-item">
                                        <strong>{{ item.date }}</strong><br>
                                        S·∫£n ph·∫©m: {{ item.product }}<br>
                                        S·ªë l∆∞·ª£ng: {{ item.quantity }}<br>
                                        Gi√°: {{ item.price }}ƒë<br>
                                        ƒê√°nh gi√°: {{ item.rate }}‚≠ê<br>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p>Ch∆∞a c√≥ l·ªãch s·ª≠ mua h√†ng.</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <h3><span style="font-size: 0.95em;">üë§</span> Kh√°ch ·∫©n danh</h3>
                        <p>B·∫°n ƒëang chat ·∫©n danh. H√£y <a href="{{ url_for('register') }}" style="color: #facc15;">ƒëƒÉng k√Ω</a> ƒë·ªÉ c√≥ tr·∫£i nghi·ªám c√° nh√¢n h√≥a.</p>
                        <a href="{{ url_for('register') }}" style="text-decoration: none; display: block; margin-bottom: 12px;">
                            <button class="logout-button" style="background-color: #3b82f6; width: 100%; margin-bottom: 0;">üìù ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi</button>
                        </a>
                    {% endif %}

                    <a href="{{ url_for('logout') }}" style="text-decoration: none;">
                        <button class="logout-button">üö™ ƒêƒÉng xu·∫•t</button>
                    </a>
                </div>

                <!-- Ph·∫ßn th√¥ng tin th√™m -->
                <div class="sidebar-info-section">
                    <hr style="border-color: #444; margin: 0.8rem 0;">
                    <h3><span style="font-size: 0.95em;">‚ÑπÔ∏è</span> Th√¥ng tin th√™m</h3>
                    <h4>Gi·ªõi thi·ªáu</h4>
                    <p style="font-size: 0.85em;">Chatbot RAG (T·∫°o sinh c√≥ tƒÉng c∆∞·ªùng truy xu·∫•t d·ªØ li·ªáu)</p>
                    <h4>T√≠nh nƒÉng</h4>
                    <ul style="font-size: 0.85em;">
                        <li>üîç T√¨m ki·∫øm ng·ªØ nghƒ©a th√¥ng minh</li>
                        <li>üß† Ph·∫£n h·ªìi theo ng·ªØ c·∫£nh</li>
                        <li>üìö T√≠ch h·ª£p kho tri th·ª©c</li>
                        <li>üë§ G·ª£i √Ω c√° nh√¢n h√≥a</li>
                        <li>üì∏ X√°c th·ª±c khu√¥n m·∫∑t</li>
                    </ul>
                    <h4>C√°ch s·ª≠ d·ª•ng</h4>
                    <ol style="font-size: 0.85em;">
                        <li>üí¨ Nh·∫≠p c√¢u h·ªèi ho·∫∑c y√™u c·∫ßu v√†o √¥ chat.</li>
                        <li>‚û°Ô∏è Nh·∫•n <b>G·ª≠i</b> ho·∫∑c <b>Enter</b> ƒë·ªÉ g·ª≠i.</li>
                        <li>üñºÔ∏è T·∫£i ·∫£nh l√™n b·∫±ng n√∫t
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-bottom: 2px;" viewBox="0 0 16 16">
                              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                              <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                            </svg>
                            c·∫°nh √¥ nh·∫≠p.
                        </li>
                        <li>ü§ñ Xem ph·∫£n h·ªìi v√† h√¨nh ·∫£nh s·∫£n ph·∫©m t·ª´ chatbot.</li>
                    </ol>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">C·∫ßn h·ªó tr·ª£? Li√™n h·ªá: üìß tranhoang0320@gmail.com</p>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="chat-area">
                <div class="title-area">
                    <h1 class="main-title">ü§ñ CHATBOT</h1>
                </div>

                <!-- Chat History -->
                <div class="chat-history" id="chat-history">
                    <div class="chat-message assistant-message">
                        <p>Xin ch√†o {{ user_info.name if user_info else 'b·∫°n' }}! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?</p>
                    </div>

                </div>

                <!-- Suggested Questions Area -->
                <div class="suggested-questions-area">
                    <div class="suggested-questions-container">
                        <div class="suggested-question" data-query-id="menu_categories">
                            <span>üìã Xem danh m·ª•c ƒë·ªì u·ªëng</span>
                        </div>
                        <div class="suggested-question" data-query-id="classic_espresso">
                            <span>‚òï Classic Espresso Drinks</span>
                        </div>
                        <div class="suggested-question" data-query-id="coffee">
                            <span>‚òï Coffee</span>
                        </div>
                        <div class="suggested-question" data-query-id="frappuccino_coffee">
                            <span>ü•§ Frappuccino Blended Coffee</span>
                        </div>
                        <div class="suggested-question" data-query-id="frappuccino_creme">
                            <span>üç¶ Frappuccino Blended Cr√®me</span>
                        </div>
                        <div class="suggested-question" data-query-id="iced_beverages">
                            <span>üßä Shaken Iced Beverages</span>
                        </div>
                        <div class="suggested-question" data-query-id="signature_espresso">
                            <span>‚ú® Signature Espresso Drinks</span>
                        </div>
                        <div class="suggested-question" data-query-id="smoothies">
                            <span>ü•≠ Smoothies</span>
                        </div>
                        <div class="suggested-question" data-query-id="tea">
                            <span>üçµ Tazo Tea Drinks</span>
                        </div>
                    </div>
                    <!-- Add shadow indicators for scrolling -->
                    <div class="scroll-shadow scroll-shadow-left"></div>
                    <div class="scroll-shadow scroll-shadow-right"></div>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <input type="text" id="user-input" placeholder="B·∫°n c·∫ßn t√¥i gi√∫p g√¨? ü§î" autocomplete="off">
                    <button id="send-button">G·ª≠i</button>
                    <input type="file" id="image-upload" accept="image/*" style="display:none;">
                    <button id="upload-button" title="T·∫£i ·∫£nh l√™n">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                          <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                          <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                        </svg>
                    </button>
                    <button id="mic-button" title="Chat b·∫±ng gi·ªçng n√≥i">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                          <path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z"/>
                        </svg>
                    </button>
                    <div class="voice-dropdown">
                        <button id="voice-settings-button" title="C√†i ƒë·∫∑t gi·ªçng n√≥i">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                              <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
                            </svg>
                        </button>
                        <div id="voice-dropdown-content" class="voice-dropdown-content">
                            <div style="font-weight: bold; padding: 5px; border-bottom: 1px solid #ddd;">Gi·ªçng ƒë·ªçc:</div>
                            <div class="voice-option" onclick="changeVoice('huyen')">N·ªØ</div>
                            <div class="voice-option" onclick="changeVoice('khanhlq')">Nam</div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const chatHistory = document.getElementById('chat-history');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');

            const imageUpload = document.getElementById('image-upload');
            const uploadButton = document.getElementById('upload-button');
            const micButton = document.getElementById('mic-button');

            // Bi·∫øn ƒë·ªÉ l∆∞u tr·ªØ ƒë·ªëi t∆∞·ª£ng nh·∫≠n d·∫°ng gi·ªçng n√≥i
            let recognition = null;
            // Bi·∫øn ƒë·ªÉ ki·ªÉm tra xem tr√¨nh duy·ªát c√≥ h·ªó tr·ª£ Web Speech API kh√¥ng
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            // Bi·∫øn ƒë·ªÉ l∆∞u tr·ªØ tr·∫°ng th√°i ƒëang ghi √¢m
            let isRecording = false;
            // Bi·∫øn ƒë·ªÉ l∆∞u tr·ªØ tr·∫°ng th√°i ƒëang ph√°t √¢m thanh
            let isPlaying = false;
            // Bi·∫øn ƒë·ªÉ l∆∞u tr·ªØ ƒë·ªëi t∆∞·ª£ng √¢m thanh
            let audioContext = null;
            let audioSource = null;
            // Gi·ªçng ƒë·ªçc m·∫∑c ƒë·ªãnh
            let currentVoice = "huyen";
            // Bi·∫øn ƒë·ªÉ theo d√µi xem ng∆∞·ªùi d√πng ƒëang s·ª≠ d·ª•ng ch·∫ø ƒë·ªô nh·∫≠p gi·ªçng n√≥i hay kh√¥ng
            // M·∫∑c ƒë·ªãnh l√† false (kh√¥ng s·ª≠ d·ª•ng gi·ªçng n√≥i)
            let voiceInputMode = false;

            // Log tr·∫°ng th√°i ban ƒë·∫ßu
            console.log("Tr·∫°ng th√°i ban ƒë·∫ßu: voiceInputMode =", voiceInputMode);

            function addMessage(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message');
                messageDiv.classList.add(role === 'user' ? 'user-message' : 'assistant-message');

                content = content.replace(/\(?(https?:\/\/[^\s]+)\)?/g, '<a href="$1" target="_blank" style="color: inherit;">$1</a>');
                // Render newlines as <br>
                content = content.replace(/\n/g, '<br>');

                // Create a wrapper for the content
                const contentWrapper = document.createElement('div');
                contentWrapper.classList.add('message-content');
                contentWrapper.innerHTML = content;

                messageDiv.appendChild(contentWrapper);
                chatHistory.appendChild(messageDiv);

                // Scroll to bottom of chat history
                chatHistory.scrollTop = chatHistory.scrollHeight;

                // Ensure suggested questions area is visible
                ensureSuggestedQuestionsVisible();

                return messageDiv;
            }

            // Function to update scroll shadows (kh√¥ng c·∫ßn ƒë·∫£m b·∫£o hi·ªÉn th·ªã v√¨ ƒë√£ c·ªë ƒë·ªãnh)
            function ensureSuggestedQuestionsVisible() {
                // Ch·ªâ c·∫ßn c·∫≠p nh·∫≠t scroll shadows
                if (typeof updateScrollShadows === 'function') {
                    setTimeout(updateScrollShadows, 100);
                }
            }

            function addImageMessage(role, imageDataUrl) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message');
                messageDiv.classList.add(role === 'user' ? 'user-message' : 'assistant-message');
                messageDiv.classList.add('image-message');

                const imgContainer = document.createElement('div');
                imgContainer.style.width = '240px';
                imgContainer.style.height = '240px';
                imgContainer.style.overflow = 'hidden';

                const img = document.createElement('img');
                img.src = imageDataUrl;
                img.alt = "Uploaded Image";
                // Let CSS handle the dimensions and styling

                imgContainer.appendChild(img);
                messageDiv.appendChild(imgContainer);
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;

                // Ensure suggested questions area is visible
                ensureSuggestedQuestionsVisible();
            }

            function displayProductImages(productImages) {
                if (!productImages || Object.keys(productImages).length === 0) {
                    return; // No product images to display
                }

                // Create a standard assistant message specifically for products
                const productsDiv = document.createElement('div');
                productsDiv.classList.add('chat-message', 'assistant-message', 'product-message');

                // Create title row that will contain the bot icon and product title
                const titleRow = document.createElement('div');
                titleRow.classList.add('title-row');

                // Add a title for the products section
                const titleElem = document.createElement('strong');
                titleElem.textContent = 'S·∫£n ph·∫©m ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p:';
                titleElem.classList.add('product-title');

                // Add the title row to the message
                titleRow.appendChild(titleElem);
                productsDiv.appendChild(titleRow);

                // Create a grid container for products
                const gridContainer = document.createElement('div');
                gridContainer.classList.add('product-grid');

                // Add special class based on number of products for balanced layout
                const productCount = Object.keys(productImages).length;
                if (productCount === 1) {
                    gridContainer.classList.add('grid-1-item');
                } else if (productCount === 2) {
                    gridContainer.classList.add('grid-2-items');
                }

                // Add each product with its image in the original order
                for (const product of productImages) {
                    const productCard = document.createElement('div');
                    productCard.style.textAlign = 'center';

                    const imageContainer = document.createElement('div');
                    imageContainer.classList.add('product-image-container');

                    const img = document.createElement('img');
                    img.src = product.image;
                    img.alt = product.name;
                    img.classList.add('product-image');

                    const nameElem = document.createElement('div');
                    nameElem.textContent = product.name;
                    nameElem.classList.add('product-name');
                    nameElem.style.color = '#181825';

                    imageContainer.appendChild(img);
                    productCard.appendChild(imageContainer);
                    productCard.appendChild(nameElem);
                    gridContainer.appendChild(productCard);
                }



                productsDiv.appendChild(gridContainer);
                chatHistory.appendChild(productsDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;

                // Ensure suggested questions area is visible
                ensureSuggestedQuestionsVisible();
            }



            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });



            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');

            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('sidebar-collapsed');

                sidebarToggle.textContent = sidebar.classList.contains('sidebar-collapsed') ? '‚ò∞' : '‚úï';
            });


            userInput.focus();

            uploadButton.addEventListener('click', () => {
                imageUpload.click();
            });

            imageUpload.addEventListener('change', async () => {
                const file = imageUpload.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const imageDataUrl = e.target.result;
                        addImageMessage('user', imageDataUrl);


                        const processingMsgDiv = addMessage('assistant', '<i>ƒêang x·ª≠ l√Ω ·∫£nh...</i>');
                        processingMsgDiv.id = 'image-processing-indicator';

                        const formData = new FormData();
                        formData.append('image', file);
                        await processImageBackend(formData);
                    }
                    reader.readAsDataURL(file);
                }

                 imageUpload.value = null;
            });

            async function processImageBackend(formData) {
                try {
                    // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa voiceInputMode ƒë·ªÉ s·ª≠ d·ª•ng sau khi nh·∫≠n ph·∫£n h·ªìi
                    const currentVoiceMode = voiceInputMode;
                    console.log("Tr·∫°ng th√°i voiceInputMode khi x·ª≠ l√Ω h√¨nh ·∫£nh:", currentVoiceMode);

                    const response = await fetch("{{ url_for('process_image') }}", {
                        method: 'POST',
                        body: formData,
                    });


                    const indicator = document.getElementById('image-processing-indicator');
                    if (indicator) {
                        chatHistory.removeChild(indicator);
                    }

                    if (!response.ok) {
                        throw new Error(`L·ªói ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const messageDiv = addMessage('assistant', result.content);

                    // Ch·ªâ ph√°t √¢m thanh khi ·ªü ch·∫ø ƒë·ªô nh·∫≠p gi·ªçng n√≥i
                    if (result.content && currentVoiceMode) {
                        console.log("ƒêang ph√°t √¢m thanh cho h√¨nh ·∫£nh (ch·∫ø ƒë·ªô gi·ªçng n√≥i)");
                        textToSpeech(result.content);
                    } else if (result.content) {
                        console.log("Kh√¥ng ph√°t √¢m thanh cho h√¨nh ·∫£nh v√¨ kh√¥ng ·ªü ch·∫ø ƒë·ªô nh·∫≠p gi·ªçng n√≥i");
                    }

                    // ƒê·∫∑t l·∫°i voiceInputMode sau khi x·ª≠ l√Ω ph·∫£n h·ªìi
                    voiceInputMode = false;

                    // Display product images if available
                    if (result.product_images) {
                        displayProductImages(result.product_images);
                    }
                } catch (error) {

                    const indicator = document.getElementById('image-processing-indicator');
                    if (indicator) {
                        chatHistory.removeChild(indicator);
                    }
                    console.error('Error processing image:', error);
                    addMessage('assistant', '‚ö†Ô∏è Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω h√¨nh ·∫£nh.');
                }
            }

            // X·ª≠ l√Ω reload trang
            window.addEventListener('beforeunload', function() {
                fetch('/reset_session');
            });

            // Kh·ªüi t·∫°o Web Speech API
            function initSpeechRecognition() {
                if (!SpeechRecognition) {
                    console.error("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Speech API");
                    micButton.style.display = "none";
                    return;
                }

                recognition = new SpeechRecognition();
                recognition.lang = 'vi-VN';  // ƒê·∫∑t ng√¥n ng·ªØ l√† ti·∫øng Vi·ªát
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = function() {
                    isRecording = true;
                    micButton.classList.add('recording');
                    console.log("B·∫Øt ƒë·∫ßu ghi √¢m...");
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    userInput.value = transcript;
                    console.log("ƒê√£ nh·∫≠n d·∫°ng: " + transcript);
                };

                recognition.onerror = function(event) {
                    console.error("L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i: " + event.error);
                    stopRecording();
                };

                recognition.onend = function() {
                    stopRecording();
                    // T·ª± ƒë·ªông g·ª≠i tin nh·∫Øn sau khi nh·∫≠n d·∫°ng gi·ªçng n√≥i
                    if (userInput.value.trim() !== '') {
                        console.log("ƒê√£ nh·∫≠n d·∫°ng gi·ªçng n√≥i, g·ª≠i tin nh·∫Øn");
                        sendMessage();
                    }
                };
            }

            // B·∫Øt ƒë·∫ßu ghi √¢m
            function startRecording() {
                if (!recognition) {
                    initSpeechRecognition();
                }

                if (recognition) {
                    try {
                        // ƒê·∫∑t ch·∫ø ƒë·ªô nh·∫≠p gi·ªçng n√≥i th√†nh true
                        voiceInputMode = true;
                        console.log("ƒê√£ b·∫≠t ch·∫ø ƒë·ªô nh·∫≠p gi·ªçng n√≥i, voiceInputMode =", voiceInputMode);
                        recognition.start();
                    } catch (e) {
                        console.error("L·ªói khi b·∫Øt ƒë·∫ßu ghi √¢m: ", e);
                    }
                }
            }

            // D·ª´ng ghi √¢m
            function stopRecording() {
                if (recognition) {
                    try {
                        recognition.stop();
                    } catch (e) {
                        console.error("L·ªói khi d·ª´ng ghi √¢m: ", e);
                    }
                }
                isRecording = false;
                micButton.classList.remove('recording');
            }

            // Chuy·ªÉn ƒë·ªïi vƒÉn b·∫£n th√†nh gi·ªçng n√≥i
            async function textToSpeech(text) {
                try {
                    console.log(`ƒêang chuy·ªÉn ƒë·ªïi vƒÉn b·∫£n th√†nh gi·ªçng n√≥i v·ªõi gi·ªçng ${currentVoice}...`);
                    console.log(`N·ªôi dung: "${text.substring(0, 100)}${text.length > 100 ? '...' : ''}"`);

                    const response = await fetch("{{ url_for('text_to_speech') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: text,
                            voice: currentVoice
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`L·ªói ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    if (!data.audio) {
                        throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu √¢m thanh t·ª´ server");
                    }

                    console.log("ƒê√£ nh·∫≠n d·ªØ li·ªáu √¢m thanh, ƒëang chu·∫©n b·ªã ph√°t...");

                    // T·∫°o m·ªôt audio element ƒë·ªÉ ph√°t √¢m thanh
                    const audio = new Audio(`data:audio/mp3;base64,${data.audio}`);

                    // Ph√°t √¢m thanh
                    isPlaying = true;
                    audio.play();

                    audio.onended = function() {
                        isPlaying = false;
                        console.log("Ph√°t √¢m thanh ho√†n t·∫•t");
                    };

                    audio.onerror = function(e) {
                        isPlaying = false;
                        console.error("L·ªói khi ph√°t √¢m thanh:", e);
                    };

                } catch (error) {
                    console.error('L·ªói khi chuy·ªÉn ƒë·ªïi vƒÉn b·∫£n th√†nh gi·ªçng n√≥i:', error);
                }
            }

            // H√†m ƒë·ªÉ thay ƒë·ªïi gi·ªçng ƒë·ªçc
            function changeVoice(voice) {
                currentVoice = voice;
                console.log(`ƒê√£ chuy·ªÉn sang gi·ªçng ƒë·ªçc: ${voice}`);
            }

            // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t microphone
            micButton.addEventListener('click', function() {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });

            // S·ª≠a h√†m sendMessage ƒë·ªÉ h·ªó tr·ª£ ph√°t √¢m thanh
            async function sendMessage() {
                const prompt = userInput.value.trim();
                if (!prompt) return;

                // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa voiceInputMode ƒë·ªÉ s·ª≠ d·ª•ng sau khi nh·∫≠n ph·∫£n h·ªìi
                const currentVoiceMode = voiceInputMode;
                console.log("Tr·∫°ng th√°i voiceInputMode khi g·ª≠i tin nh·∫Øn:", currentVoiceMode);

                addMessage('user', prompt);
                userInput.value = '';
                sendButton.disabled = true;
                userInput.disabled = true;
                sendButton.textContent = '...';

                // Thinking indicator
                const thinkingDiv = document.createElement('div');
                thinkingDiv.classList.add('chat-message', 'assistant-message');
                thinkingDiv.innerHTML = '<i>ƒêang x·ª≠ l√Ω...ü§î</i>';
                thinkingDiv.id = 'thinking-indicator';
                chatHistory.appendChild(thinkingDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;

                try {
                    const response = await fetch("{{ url_for('chat') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    // Remove thinking indicator
                    const indicator = document.getElementById('thinking-indicator');
                    if (indicator) {
                        chatHistory.removeChild(indicator);
                    }

                    if (!response.ok) {
                        let errorMsg = `L·ªói ${response.status}: ${response.statusText}`;
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.error || errorMsg;
                        } catch (e) { /* Ignore if body isn't JSON */ }
                        addMessage('assistant', `‚ö†Ô∏è Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra: ${errorMsg}`);
                    } else {
                        const data = await response.json();
                        if (data.role === 'assistant') {
                            const messageDiv = addMessage('assistant', data.content);

                            // Ch·ªâ ph√°t √¢m thanh khi ·ªü ch·∫ø ƒë·ªô nh·∫≠p gi·ªçng n√≥i
                            if (data.content && currentVoiceMode) {
                                console.log("ƒêang ph√°t √¢m thanh cho ph·∫£n h·ªìi (ch·∫ø ƒë·ªô gi·ªçng n√≥i)");
                                textToSpeech(data.content);
                            } else if (data.content) {
                                console.log("Kh√¥ng ph√°t √¢m thanh v√¨ kh√¥ng ·ªü ch·∫ø ƒë·ªô nh·∫≠p gi·ªçng n√≥i");
                            }

                            // ƒê·∫∑t l·∫°i voiceInputMode sau khi x·ª≠ l√Ω ph·∫£n h·ªìi
                            voiceInputMode = false;

                            // Display product images if available
                            if (data.product_images) {
                                displayProductImages(data.product_images);
                            }
                        }
                    }

                } catch (error) {
                    console.error('Error sending message:', error);
                    const indicator = document.getElementById('thinking-indicator');
                    if (indicator) {
                        chatHistory.removeChild(indicator);
                    }
                    addMessage('assistant', '‚ö†Ô∏è Xin l·ªói, ƒë√£ c√≥ l·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng th·ª≠ l·∫°i.');
                } finally {
                    sendButton.disabled = false;
                    userInput.disabled = false;
                    sendButton.textContent = 'G·ª≠i';
                    userInput.focus();


                }
            }

            // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t c√†i ƒë·∫∑t gi·ªçng n√≥i
            const voiceSettingsButton = document.getElementById('voice-settings-button');
            const voiceDropdownContent = document.getElementById('voice-dropdown-content');
            const voiceOptions = document.querySelectorAll('.voice-option');

            voiceSettingsButton.addEventListener('click', function() {
                voiceDropdownContent.classList.toggle('show');
            });

            // ƒê√≥ng dropdown khi nh·∫•p v√†o b√™n ngo√†i
            window.addEventListener('click', function(event) {
                if (!event.target.matches('#voice-settings-button') &&
                    !event.target.closest('#voice-settings-button') &&
                    !event.target.matches('.voice-dropdown-content') &&
                    !event.target.closest('.voice-dropdown-content')) {
                    if (voiceDropdownContent.classList.contains('show')) {
                        voiceDropdownContent.classList.remove('show');
                    }
                }
            });

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i active cho gi·ªçng ƒë·ªçc hi·ªán t·∫°i
            function updateActiveVoice() {
                voiceOptions.forEach(option => {
                    const voiceValue = option.getAttribute('onclick').match(/'([^']+)'/)[1];
                    if (voiceValue === currentVoice) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
            }

            // Ghi ƒë√® h√†m changeVoice ƒë·ªÉ c·∫≠p nh·∫≠t UI
            const originalChangeVoice = changeVoice;
            changeVoice = function(voice) {
                originalChangeVoice(voice);
                updateActiveVoice();
                voiceDropdownContent.classList.remove('show');
            };

            // Kh√¥ng c·∫ßn h√†m ki·ªÉm tra d·ªãch v·ª• gi·ªçng n√≥i n·ªØa

            // Kh·ªüi t·∫°o Web Speech API v√† c·∫≠p nh·∫≠t UI khi trang ƒë∆∞·ª£c t·∫£i
            initSpeechRecognition();
            updateActiveVoice();

            // Handle scroll shadows and drag-to-scroll for suggested questions
            const suggestedQuestionsArea = document.querySelector('.suggested-questions-area');
            const leftShadow = document.querySelector('.scroll-shadow-left');
            const rightShadow = document.querySelector('.scroll-shadow-right');

            // Variables for drag scrolling
            let isDown = false;
            let startX;
            let scrollLeft;

            // Function to update scroll shadows
            function updateScrollShadows() {
                if (suggestedQuestionsArea.scrollLeft > 10) {
                    leftShadow.style.opacity = '1';
                } else {
                    leftShadow.style.opacity = '0';
                }

                if (suggestedQuestionsArea.scrollWidth - suggestedQuestionsArea.scrollLeft - suggestedQuestionsArea.clientWidth < 10) {
                    rightShadow.style.opacity = '0';
                } else {
                    rightShadow.style.opacity = '1';
                }
            }

            // Initial update
            updateScrollShadows();

            // Update on scroll
            suggestedQuestionsArea.addEventListener('scroll', updateScrollShadows);

            // Update on window resize
            window.addEventListener('resize', updateScrollShadows);

            // Mouse events for drag scrolling
            suggestedQuestionsArea.addEventListener('mousedown', (e) => {
                isDown = true;
                suggestedQuestionsArea.classList.add('dragging');
                suggestedQuestionsArea.style.cursor = 'grabbing';
                startX = e.pageX - suggestedQuestionsArea.offsetLeft;
                scrollLeft = suggestedQuestionsArea.scrollLeft;
                // Prevent text selection during drag
                e.preventDefault();
            });

            suggestedQuestionsArea.addEventListener('mouseleave', () => {
                isDown = false;
                suggestedQuestionsArea.classList.remove('dragging');
                suggestedQuestionsArea.style.cursor = 'grab';
            });

            suggestedQuestionsArea.addEventListener('mouseup', () => {
                isDown = false;
                suggestedQuestionsArea.classList.remove('dragging');
                suggestedQuestionsArea.style.cursor = 'grab';
            });

            suggestedQuestionsArea.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - suggestedQuestionsArea.offsetLeft;
                const walk = (x - startX) * 2; // Scroll speed multiplier
                suggestedQuestionsArea.scrollLeft = scrollLeft - walk;
            });

            // Touch events for mobile drag scrolling
            suggestedQuestionsArea.addEventListener('touchstart', (e) => {
                isDown = true;
                suggestedQuestionsArea.classList.add('dragging');
                startX = e.touches[0].pageX - suggestedQuestionsArea.offsetLeft;
                scrollLeft = suggestedQuestionsArea.scrollLeft;
            }, { passive: true });

            suggestedQuestionsArea.addEventListener('touchend', () => {
                isDown = false;
                suggestedQuestionsArea.classList.remove('dragging');
            });

            suggestedQuestionsArea.addEventListener('touchmove', (e) => {
                if (!isDown) return;
                const x = e.touches[0].pageX - suggestedQuestionsArea.offsetLeft;
                const walk = (x - startX) * 2;
                suggestedQuestionsArea.scrollLeft = scrollLeft - walk;
            }, { passive: true });

            // Handle suggested questions
            const suggestedQuestions = document.querySelectorAll('.suggested-question');

            // Category mapping for quick lookup
            const categoryMap = {
                'Classic Espresso Drinks': 'classic_espresso',
                'Coffee': 'coffee',
                'Frappuccino Blended Coffee': 'frappuccino_coffee',
                'Frappuccino Blended Cr√®me': 'frappuccino_creme',
                'Shaken Iced Beverages': 'iced_beverages',
                'Signature Espresso Drinks': 'signature_espresso',
                'Smoothies': 'smoothies',
                'Tazo Tea Drinks': 'tea'
            };

            // Process suggested query response
            async function processSuggestedQuery(queryId, questionText) {
                // Add user message to chat
                addMessage('user', `Cho t√¥i xem ${questionText}`);

                // Show loading indicator
                const thinkingDiv = document.createElement('div');
                thinkingDiv.classList.add('chat-message', 'assistant-message');
                thinkingDiv.innerHTML = '<i>ƒêang t·∫£i d·ªØ li·ªáu menu...ü§î</i>';
                thinkingDiv.id = 'suggested-query-indicator';
                chatHistory.appendChild(thinkingDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;

                try {
                    // Fetch data from server
                    const response = await fetch("{{ url_for('suggested_query') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query_id: queryId })
                    });

                    // Remove loading indicator
                    removeLoadingIndicator();

                    if (!response.ok) {
                        throw new Error(`L·ªói ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();

                    if (data.role === 'assistant' && data.content_type === 'menu_data') {
                        displayMenuData(data);
                    }
                } catch (error) {
                    console.error('Error processing suggested query:', error);
                    removeLoadingIndicator();
                    addMessage('assistant', `‚ö†Ô∏è L·ªói khi x·ª≠ l√Ω truy v·∫•n: ${error.message}`);
                }
            }

            // Remove loading indicator
            function removeLoadingIndicator() {
                const indicator = document.getElementById('suggested-query-indicator');
                if (indicator) {
                    chatHistory.removeChild(indicator);
                }
            }

            // Display menu data based on type
            function displayMenuData(data) {
                // Create message content with title
                let messageContent = `<span class="menu-title">${data.data.title}</span>`;

                if (data.data.type === 'categories') {
                    displayCategoriesData(data, messageContent);
                } else if (data.data.type === 'products') {
                    displayProductsData(data, messageContent);
                }
            }

            // Display categories data
            function displayCategoriesData(data, messageContent) {
                // Add subtitle
                messageContent += '<span class="menu-subtitle">C√°c danh m·ª•c ƒë·ªì u·ªëng:</span>';

                // Add categories list
                data.data.items.forEach(category => {
                    messageContent += `<div class="menu-item" data-category="${category.name}">- ${category.name}</div>\n`;
                });

                // Add to chat
                const messageDiv = addMessage('assistant', messageContent);

                // Add click events to category items
                setTimeout(addCategoryClickHandlers, 100);
            }

            // Add click handlers to category items
            function addCategoryClickHandlers() {
                const categoryItems = document.querySelectorAll('.menu-item');
                categoryItems.forEach(item => {
                    item.style.cursor = 'pointer';
                    item.addEventListener('click', () => {
                        const categoryName = item.dataset.category;
                        const queryId = categoryMap[categoryName];
                        if (queryId) {
                            const button = document.querySelector(`.suggested-question[data-query-id="${queryId}"]`);
                            if (button) {
                                button.click();
                            }
                        }
                    });
                });
            }

            // Display products data
            function displayProductsData(data, messageContent) {
                // Add subtitle
                messageContent += `<span class="menu-subtitle">C√°c s·∫£n ph·∫©m trong danh m·ª•c ${data.data.title}:</span>`;

                // Add products list
                data.data.items.forEach(product => {
                    messageContent += `<div class="menu-product"><span class="product-name">- ${product.name}</span><span class="product-description">${product.description}</span></div>\n`;
                });

                // Add to chat
                addMessage('assistant', messageContent);

                // Display product images if available
                if (data.product_images && data.product_images.length > 0) {
                    displayProductImages(data.product_images);
                }
            }

            // Add click event to each suggested question
            suggestedQuestions.forEach(question => {
                question.addEventListener('click', function() {
                    const queryId = this.dataset.queryId;
                    const questionText = this.innerText.trim();
                    processSuggestedQuery(queryId, questionText);
                });
            });
        </script>
    </body>
    </html>